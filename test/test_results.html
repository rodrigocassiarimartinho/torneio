<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Teste do Módulo de Resultados</title>
    <style>
        /* ... (estilos do teste anterior) ... */
    </style>
</head>
<body>
    <h1>Validação do Módulo de Resultados (`results.js`)</h1>
    <div id="test-results"></div>

    <script type="module">
        import { buildDoubleBracketStructure } from '../js/structures/double_bracket_structure.js';
        import { populateDoubleBracket } from '../js/logic/double_player_logic.js';
        import { resolveMatch, resolveInitialByes } from '../js/results.js';
        import { parsePlayerInput } from '../js/parsing.js';
        import { getNextPowerOfTwo } from '../js/math.js';

        const resultsContainer = document.getElementById('test-results');
        const playerList = `1. Ana\n2. Bia\n3. Carlos\n4. Davi\n5. Eva\n6. Fabio`; // 6 Jogadores -> 2 Byes
        const { seededPlayers, unseededPlayers } = parsePlayerInput(playerList);
        const playerCount = seededPlayers.length + unseededPlayers.length;

        let structure = buildDoubleBracketStructure(playerCount);
        let tournamentData = { type: 'double', ...populateDoubleBracket(structure, playerList) };

        // --- TESTE 1: Resolução Automática dos Byes ---
        const initialStateByes = JSON.parse(JSON.stringify(tournamentData));
        const stateAfterByes = resolveInitialByes(initialStateByes);
        
        let byeTestHtml = `<div class="test-case"><h2>Teste 1: Resolução Automática dos Byes</h2>`;
        const anaInV2 = stateAfterByes.winnersBracket[1][0].p1.name === 'Ana';
        const biaInV2 = stateAfterByes.winnersBracket[1][1].p2.name === 'Bia';
        
        // **INÍCIO DA CORREÇÃO DO TESTE**
        // Procura pelo bye que perdeu para a Ana (M1) e verifica se ele está na partida correta (M8)
        const bye1 = initialStateByes.winnersBracket[0].find(m => m.p1?.name === 'Ana').p2;
        const bye1DroppedCorrectly = stateAfterByes.losersBracket[0][0].p1.name === bye1.name;

        // Procura pelo bye que perdeu para a Bia (M3) e verifica se ele está na partida correta (M9)
        const bye2 = initialStateByes.winnersBracket[0].find(m => m.p1?.name === 'Bia').p2;
        const bye2DroppedCorrectly = stateAfterByes.losersBracket[0][1].p1.name === bye2.name;
        // **FIM DA CORREÇÃO DO TESTE**

        if (anaInV2 && biaInV2 && bye1DroppedCorrectly && bye2DroppedCorrectly) {
            byeTestHtml += `<p class="success">✔️ SUCESSO: Byes resolvidos e avançados corretamente.</p>`;
        } else {
            byeTestHtml += `<p class="fail">❌ FALHA: A resolução de byes falhou.</p>`;
        }
        byeTestHtml += `<div class="state-container"><div class="state"><h3>Estado Inicial</h3><pre>${JSON.stringify(initialStateByes, null, 2)}</pre></div>`;
        byeTestHtml += `<div class="state"><h3>Estado Final (Pós-Byes)</h3><pre>${JSON.stringify(stateAfterByes, null, 2)}</pre></div></div></div>`;
        resultsContainer.innerHTML += byeTestHtml;
        
        // ... (resto do teste da partida manual)

    </script>
</body>
</html>
